#!/bin/bash
# Pull app APK and files from remote device running a rooted SSHd
# Assumes that 'ssh root@android' already works via SSH key/config

# List installed third party packages
echo "The following packages are installed: "
ssh root@android pm list packages -3 | cut -d':' -f2

# Get package_name from argument
read -p "Enter the package name to pull: " package_name

# Get installed package version from remote
package_version=$(ssh root@android dumpsys package $package_name | grep versionCode | cut -d'=' -f2 | cut -d' ' -f1)

# Get path to APK from remote
remote_apk_path=$(ssh root@android pm path $package_name | cut -d':' -f2)

# Copy APK from remote
echo "Pulling $package_name versionCode $package_version APK..."
mkdir -p $package_name-$package_version/
scp root@android:$remote_apk_path $package_name-$package_version/$package_name-$package_version.apk

# Copy app files from remote
echo "Pulling /data/user/0/$package_name/ files..."
mkdir -p $package_name-$package_version/files/
scp -r root@android:/data/user/0/$package_name/* $package_name-$package_version/files/

# Get app UID from remote
app_uid=$(ssh root@android stat -c '%U' /data/user/0/$package_name/ | cut -d'a' -f2)

# Get Keystore files associated with UID
echo "Pulling $package_name /data/misc/keystore/user_0/10$app_uid* keystore files..."
mkdir -p $package_name-$package_version/keystore/
scp -r root@android:/data/misc/keystore/user_0/10$app_uid* $package_name-$package_version/keystore/